<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONGLE_PRIVATE_LINK // NEON_GRN</title>
    <style>
        :root { --neon: #39ff14; --bg: #050505; --dark-neon: #1a5c0a; --admin: #ff0000; }
        
        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999; background-size: 100% 3px, 6px 100%; pointer-events: none;
        }

        body { 
            background: var(--bg); color: var(--neon); 
            font-family: 'Courier New', monospace; margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            text-transform: uppercase; font-weight: bold;
        }

        #admin-trigger {
            position: fixed; top: 0; right: 0; width: 30px; height: 30px;
            background: var(--admin); z-index: 10000; cursor: pointer;
            clip-path: polygon(100% 0, 0 0, 100% 100%); opacity: 0.2;
        }

        header { 
            border-bottom: 4px solid var(--neon); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg); box-shadow: 0 5px 15px rgba(57, 255, 20, 0.2);
            z-index: 100;
        }

        #container { display: flex; flex: 1; overflow: hidden; position: relative; }

        #sidebar { 
            width: 260px; border-right: 4px solid var(--neon); 
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            transition: margin-left 0.3s ease; background: var(--bg);
            position: relative; z-index: 10;
        }

        #sidebar.collapsed { margin-left: -304px; }

        #toggle-btn {
            position: absolute; right: -34px; top: 50%; transform: translateY(-50%);
            background: var(--bg); border: 4px solid var(--neon); color: var(--neon);
            width: 30px; height: 60px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 1.2rem; z-index: 11;
        }

        #chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }

        #messages { flex: 1; overflow-y: scroll; padding: 20px; display: flex; flex-direction: column; gap: 10px; }

        /* TYPING INDICATOR STYLE */
        #typing-status {
            padding: 5px 20px; font-size: 0.7rem; color: var(--dark-neon);
            height: 20px; font-style: italic;
        }

        .msg { 
            border: 2px solid var(--neon); padding: 12px; background: #000;
            box-shadow: 6px 6px 0px var(--neon); margin-bottom: 10px; align-self: flex-start; max-width: 80%;
        }
        .msg.mine { align-self: flex-end; box-shadow: -6px 6px 0px var(--neon); border-color: #fff; color: #fff; }
        .msg-meta { font-size: 0.7rem; color: var(--dark-neon); margin-bottom: 5px; }

        .input-bar { 
            border-top: 4px solid var(--neon); padding: 20px; 
            display: grid; grid-template-columns: 150px 1fr 120px; gap: 15px; background: #000;
        }

        input { background: #000; border: 2px solid var(--neon); color: var(--neon); padding: 10px; outline: none; font-family: inherit; font-weight: bold; }
        button { background: var(--neon); color: #000; border: none; font-weight: 900; cursor: pointer; }
        
        .room-tag { padding: 8px; border: 1px solid var(--neon); cursor: pointer; font-size: 0.8rem; }
        #admin-panel { display: none; background: var(--admin); color: #fff; padding: 5px; text-align: center; }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--neon); border: 2px solid #000; }
    </style>
</head>
<body>

<div id="admin-trigger" onclick="openAdmin()"></div>

<header>
    <div>MONGLE_ARCADE // <span id="room-display">LOBBY</span></div>
    <div id="status" style="font-size: 0.7rem;">STATUS: ENCRYPTED_ONLINE</div>
</header>

<div id="admin-panel">
    ROOT_ACCESS_GRANTED | <button onclick="wipeRoom()" style="background:white; color:red; padding:2px 10px;">PURGE_DATA</button>
</div>

<div id="container">
    <div id="sidebar">
        <div id="toggle-btn" onclick="toggleSidebar()">&#10094;</div>
        <div style="border-bottom: 2px solid var(--neon); margin-bottom: 10px;">PUBLIC_NODES</div>
        <div id="room-list" style="display:flex; flex-direction:column; gap:5px;"></div>
        <div style="margin-top: auto; border-top: 2px solid var(--neon); padding-top: 10px;">PRIVATE_LINK</div>
        <input type="text" id="privRoomInput" placeholder="SECRET_ID...">
        <button onclick="joinRoom(document.getElementById('privRoomInput').value)">CONNECT</button>
    </div>

    <div id="chat-main">
        <div id="messages"></div>
        <div id="typing-status"></div> <div class="input-bar">
            <input type="text" id="username" placeholder="USER_ID">
            <input type="text" id="messageInput" placeholder="TYPE_DATA_PACKET...">
            <button id="sendBtn">EXECUTE</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onValue, remove, off, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgRvxKypPsOx379SNleE6Uij7mKkEJxGY",
    authDomain: "monglearcade.firebaseapp.com",
    databaseURL: "https://monglearcade-default-rtdb.firebaseio.com",
    projectId: "monglearcade",
    storageBucket: "monglearcade.firebasestorage.app",
    messagingSenderId: "637983149122",
    appId: "1:637983149122:web:e6969750929fbb6b1871db"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  let currentRoom = "LOBBY";
  let chatRef = ref(db, 'rooms/' + currentRoom + '/messages');
  let typingRef = ref(db, 'rooms/' + currentRoom + '/typing');

  // --- Sidebar Logic ---
  window.toggleSidebar = () => {
    const s = document.getElementById('sidebar');
    const b = document.getElementById('toggle-btn');
    s.classList.toggle('collapsed');
    b.innerHTML = s.classList.contains('collapsed') ? "&#10095;" : "&#10094;";
  };

  // --- Typing Logic ---
  const msgInput = document.getElementById('messageInput');
  const userField = document.getElementById('username');

  msgInput.oninput = () => {
    const user = userField.value || "ANON";
    if (msgInput.value.length > 0) {
        set(ref(db, `rooms/${currentRoom}/typing/${user}`), true);
        onDisconnect(ref(db, `rooms/${currentRoom}/typing/${user}`)).remove();
    } else {
        remove(ref(db, `rooms/${currentRoom}/typing/${user}`));
    }
  };

  // --- Listen for Typing ---
  function watchTyping() {
    onValue(ref(db, `rooms/${currentRoom}/typing`), (snap) => {
        const typers = snap.val() || {};
        const currentUser = (userField.value || "ANON").toUpperCase();
        const active = Object.keys(typers).filter(u => u.toUpperCase() !== currentUser);
        
        const statusEl = document.getElementById('typing-status');
        if (active.length > 0) {
            statusEl.innerText = `${active.join(", ")} IS ACCESSING THE BUFFER...`;
        } else {
            statusEl.innerText = "";
        }
    });
  }

  // --- Join Room ---
  window.joinRoom = (name) => {
    if (!name || name === currentRoom) return;
    off(chatRef);
    off(typingRef);
    // Cleanup typing status before leaving
    remove(ref(db, `rooms/${currentRoom}/typing/${userField.value || "ANON"}`));
    
    currentRoom = name.toUpperCase().replace(/\s/g, '_');
    document.getElementById('room-display').innerText = currentRoom;
    document.getElementById('messages').innerHTML = `<div class="msg">SYSTEM: SYNCED TO [${currentRoom}]</div>`;
    chatRef = ref(db, 'rooms/' + currentRoom + '/messages');
    typingRef = ref(db, 'rooms/' + currentRoom + '/typing');
    initListener();
    watchTyping();
  };

  // --- Messaging ---
  const send = () => {
    const text = msgInput.value;
    const user = userField.value || "ANON";
    if (text.trim()) {
      push(chatRef, { user: user.toUpperCase(), text, time: new Date().toLocaleTimeString() });
      msgInput.value = "";
      remove(ref(db, `rooms/${currentRoom}/typing/${user}`)); // Clear typing on send
    }
  };

  document.getElementById('sendBtn').onclick = send;
  msgInput.onkeypress = (e) => { if(e.key==='Enter') send(); };

  function initListener() {
    onChildAdded(chatRef, (snap) => {
      const d = snap.val();
      const area = document.getElementById('messages');
      const isMe = d.user === (userField.value || "ANON").toUpperCase();
      area.innerHTML += `<div class="msg ${isMe ? 'mine' : ''}"><div class="msg-meta">${d.user} // ${d.time}</div><div>${d.text}</div></div>`;
      area.scrollTop = area.scrollHeight;
    });
  }

  // --- Public Nodes ---
  onValue(ref(db, 'rooms'), (snapshot) => {
    const list = document.getElementById('room-list');
    list.innerHTML = "";
    snapshot.forEach((child) => {
      const el = document.createElement('div');
      el.className = "room-tag";
      el.innerText = "> " + child.key;
      el.onclick = () => joinRoom(child.key);
      list.appendChild(el);
    });
  });

  // --- Admin ---
  window.openAdmin = () => { if(prompt("ENTER_ROOT_KEY:") === "mongle123") document.getElementById('admin-panel').style.display = 'block'; };
  window.wipeRoom = () => { if(confirm("PERMANENT_WIPE?")) remove(ref(db, 'rooms/' + currentRoom)); };

  initListener();
  watchTyping();
</script>
</body>
</html>
